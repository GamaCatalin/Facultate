     1                                  bits 32 ; assembling for the 32 bits architecture
     2                                  
     3                                  ; declare the EntryPoint (a label defining the very first instruction of the program)
     4                                  global start        
     5                                  
     6                                  ; declare external functions needed by our program
     7                                  extern exit               ; tell nasm that exit exists even if we won't be defining it
     8                                  import exit msvcrt.dll    ; exit is a function that ends the calling process. It is defined in msvcrt.dll
     9                                  extern fopen
    10                                  import fopen msvcrt.dll
    11                                  extern fclose
    12                                  import fclose msvcrt.dll
    13                                  extern fprintf
    14                                  import fprintf msvcrt.dll
    15                                  extern fread
    16                                  import fread msvcrt.dll
    17                                  extern printf
    18                                  import printf msvcrt.dll
    19                                  extern scanf
    20                                  import scanf msvcrt.dll
    21                                                            ; msvcrt.dll contains exit, printf and all the other important C-runtime specific functions
    22                                  
    23                                  ; our data is declared here (the variables needed by our program)
    24                                  segment data use32 class=data
    25                                      ; ...
    26                                  
    27                                      
    28 00000000 6F757470757433302E-         fileName db "output30.txt",0
    28 00000009 74787400           
    29 0000000D 6100                        fileFormat db "a",0
    30 0000000F 24                          stopChar db "$"
    31 00000010 00000000                    fileDescriptor dd 0
    32 00000014 257300                      scanFormat db "%s",0
    33 00000017 25732000                    outputFormat db "%s ",0
    34 0000001B 256300                      charFormat db "%c", 0
    35 0000001E 00                          index db 0
    36 0000001F 00000000                    buffer dd "",0
    37                                      lenWord equ 132
    38                                      
    39                                      
    40                                      
    41                                  ; our code starts here
    42                                  segment code use32 class=code
    43                                      start:
    44                                          ; ...
    45                                          
    46                                          ;A file name (defined in data segment) is given. Create a file with the given name, then read words from the keyboard until character '$' is read from the keyboard. Write only the words that contain at least
    47                                          
    48                                          
    49                                          
    50 00000000 68[0D000000]                    push dword fileFormat               ;push the file format
    51 00000005 68[00000000]                    push dword fileName                 ;push the file name
    52 0000000A FF15[00000000]                  call [fopen]                        ;open the file
    53 00000010 83C408                          add ESP, 4*2                        ;clear the stack
    54                                          
    55 00000013 A3[10000000]                    mov [fileDescriptor],EAX            ;save the file descriptor
    56                                          
    57 00000018 83F800                          cmp EAX,0                           ;check if the file has been open
    58 0000001B 7476                            je endProgram
    59                                          
    60                                          
    61 0000001D B901000000                      mov ECX, 1                          ;initialize ecx
    62                                          
    63                                          
    64                                          mainLoop:       
    65 00000022 68[1F000000]                    push dword buffer                   ;push the buffer
    66 00000027 68[14000000]                    push dword scanFormat               ;push the format
    67 0000002C FF15[00000000]                  call [scanf]                        ;read from keyboard
    68 00000032 83C408                          add ESP, 4*2                        ;clear the stack
    69                                  
    70                                          
    71 00000035 A0[0F000000]                    mov AL, [stopChar]                  ;check if the read word is the stopping word
    72 0000003A 3805[1F000000]                  cmp [buffer], AL
    73 00000040 7442                            je cleanup
    74                                              
    75                                          
    76 00000042 BE00000000                      mov ESI, 0                          ;clear esi
    77                                          
    78                                          wordLoop:
    79                                             
    80 00000047 8A86[1F000000]                      mov AL, [buffer+ESI]            ;get the current char from the word
    81 0000004D 6698                                cbw
    82 0000004F 98                                  cwde
    83                                          
    84 00000050 83F830                              cmp EAX, '0'                    ;check if it is a digit
    85 00000053 7D02                                jge possibleNumber
    86 00000055 EB07                                jmp nextIteration
    87                                          
    88                                              possibleNumber:
    89 00000057 83F839                              cmp EAX,'9'
    90 0000005A 7F02                                jg notNumber
    91                                              
    92 0000005C 760B                                jbe containsDigit
    93                                          
    94                                              notNumber:
    95                                              nextIteration:
    96 0000005E 46                                      inc ESI                     ;increment ESI
    97                                              
    98 0000005F 81FE84000000                            cmp ESI, lenWord            ;check if it is less than the max lenght of the word
    99 00000065 76E0                                    jbe wordLoop
   100                                        
   101 00000067 EB19                            jmp nextWord                        ;if the word didn't contain a digit, read the next one
   102                                        
   103                                          containsDigit:                      
   104 00000069 68[1F000000]                        push dword buffer               ;push the word 
   105 0000006E 68[17000000]                        push dword outputFormat         ;push the format
   106 00000073 FF35[10000000]                      push dword [fileDescriptor]     ;push the file descriptor
   107 00000079 FF15[00000000]                      call [fprintf]                  ;write to file
   108 0000007F 83C40C                              add ESP, 4*3                    ;clear the stack
   109                                          
   110                                          nextWord:
   111                                          
   112 00000082 E29E                            loop mainLoop
   113                                          
   114                                          
   115                                          
   116                                          
   117                                          cleanup:
   118 00000084 FF35[10000000]                      push dword [fileDescriptor]     ;push the file descriptor
   119 0000008A FF15[00000000]                      call [fclose]                   ;close the file
   120 00000090 83C404                              add ESP, 4*1                    ;clear the stack
   121                                          
   122                                          
   123                                          
   124                                          endProgram:
   125                                          
   126                                      
   127                                          ; exit(0)
   128 00000093 6A00                            push    dword 0      ; push the parameter for exit onto the stack
   129 00000095 FF15[00000000]                  call    [exit]       ; call exit to terminate the program
