     1                                  bits 32 ; assembling for the 32 bits architecture
     2                                  
     3                                  ; declare the EntryPoint (a label defining the very first instruction of the program)
     4                                  global start        
     5                                  
     6                                  ; declare external functions needed by our program
     7                                  extern exit               ; tell nasm that exit exists even if we won't be defining it
     8                                  import exit msvcrt.dll    ; exit is a function that ends the calling process. It is defined in msvcrt.dll
     9                                                            ; msvcrt.dll contains exit, printf and all the other important C-runtime specific functions
    10                                  
    11                                  ; our data is declared here (the variables needed by our program)
    12                                  segment data use32 class=data
    13                                      ; ...
    14                                  
    15 00000000 330C76107A02722176-         A dw 3123,4214,634,8562,4214
    15 00000009 10                 
    16                                      lenghtA equ ($-A)
    17 0000000A FF                          control1 db 0FFh
    18 0000000B 00<rept>                    s1 times lenghtA/2 db 0
    19 00000010 FF                          control2 db 0FFh
    20 00000011 00<rept>                    s2 times lenghtA/2 db 0
    21 00000016 FF                          control3 db 0FFh
    22                                      
    23 00000017 00                          byteHigh db 0
    24 00000018 FF                          control4 db 0FFh
    25 00000019 00                          byteLow db 0
    26 0000001A FF                          control5 db 0FFh
    27 0000001B 00                          counterHigh db 0
    28 0000001C FF                          control6 db 0FFh
    29 0000001D 00                          counterLow db 0
    30 0000001E FF                          control7 db 0FFh
    31 0000001F 00000000                    loopReminder dd 0
    32                                      
    33                                      
    34                                      
    35                                      
    36                                  ; our code starts here
    37                                  segment code use32 class=code
    38                                      start:
    39                                          ; ...
    40                                          
    41                                          ;A string of words is given. Build two strings of bytes, s1 and s2, in the following way: for each word,
    42                                          ;if the number of bits 1 from the high byte of the word is larger than the number of bits 1 from its low byte, then s1 will contain the high byte and s2 will contain the low byte of the word
    43                                          ;if the number of bits 1 from the high byte of the word is equal to the number of bits 1 from its low byte, then s1 will contain the number of bits 1 from the low byte and s2 will contain 0
    44                                          ;otherwise, s1 will contain the low byte and s2 will contain the high byte of the word.
    45                                      
    46                                   
    47 00000000 B905000000                      mov ECX, lenghtA/2                          ;move into ECX the times we have to repeat the loop
    48 00000005 BE[00000000]                    mov ESI, A
    49 0000000A BF00000000                      mov EDI, 0
    50                                  
    51                                          
    52                                          mainLoop:
    53 0000000F 66AD                                LODSW
    54                                              
    55 00000011 A2[19000000]                        mov [byteLow], AL
    56 00000016 8825[17000000]                      mov [byteHigh], AH
    57                                              
    58 0000001C 890D[1F000000]                      mov [loopReminder], ECX
    59 00000022 B908000000                          mov ECX, 8
    60                                             
    61 00000027 C605[1D000000]00                    mov [counterLow], byte 0
    62 0000002E C605[1B000000]00                    mov [counterHigh], byte 0
    63                                              
    64                                              bitCounterLoop:
    65 00000035 D02D[19000000]                          shr byte [byteLow], 1
    66 0000003B 7306                                    jnc lowIsZero
    67                                                      
    68                                                  lowIsOne:
    69 0000003D FE05[1D000000]                              inc byte [counterLow]
    70                                              
    71                                                  lowIsZero:
    72                                                  
    73                                                      
    74 00000043 D02D[17000000]                          shr byte [byteHigh], 1
    75 00000049 7306                                    jnc highIsZero
    76                                                  
    77                                                  hightIsOne:
    78 0000004B FE05[1B000000]                              inc byte [counterHigh]
    79                                                      
    80                                                  highIsZero:
    81                                                  
    82 00000051 E2E2                                loop bitCounterLoop
    83                                  
    84                                  
    85 00000053 8B0D[1F000000]                      mov ECX, [loopReminder]
    86                                      
    87 00000059 668B15[1B000000]                    mov DX, [counterHigh]
    88 00000060 663B15[1D000000]                    cmp DX, [counterLow]
    89                                              
    90 00000067 7F0A                                jg highGreater
    91 00000069 740A                                je highEqual
    92                                              
    93                                              highLess:
    94 0000006B 88C2                                    mov DL, AL
    95 0000006D 88E0                                    mov AL, AH
    96 0000006F 88D4                                    mov AH, DL
    97 00000071 EB0C                                    jmp endLoop
    98                                                  
    99                                              highGreater:   
   100 00000073 EB0A                                    jmp endLoop
   101                                              
   102                                              highEqual:
   103 00000075 8A25[1D000000]                          mov AH, [counterLow]
   104 0000007B B000                                    mov AL, 0
   105 0000007D EB00                                    jmp endLoop
   106                                                  
   107                                      
   108                                              endLoop:
   109 0000007F 88A7[0B000000]                          mov [s1+EDI], AH
   110 00000085 8887[11000000]                          mov [s2+EDI], AL   
   111 0000008B 47                                      inc EDI                 
   112                                      
   113 0000008C E281                            loop mainLoop
   114                                      
   115                                          ; exit(0)
   116 0000008E 6A00                            push    dword 0      ; push the parameter for exit onto the stack
   117 00000090 FF15[00000000]                  call    [exit]       ; call exit to terminate the program
